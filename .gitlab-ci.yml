stages:
  - test

pylint:
  image: python:2.7-alpine
  stage: test
  tags:
    - docker
  script:
    - apk add -U git
    - pip install pylint
    - pylint --rcfile=.pylintrc $(git ls-tree --name-only --full-tree -r HEAD | grep '\.py' | sort | tr '\n' ' ') || RETCODE=1

unittest:
  image: python:2.7-alpine
  stage: test
  cache:
    paths:
      - build/
  artifacts:
    paths:
      - setup.log
    expire_in: '1 day'
  script:
    - apk add -U bash gcc gnupg linux-headers musl-dev npm py2-virtualenv py-cffi > /dev/null 2>&1
    - mkdir /etc/upgrade
    - touch /etc/builddate
    - ./tellstick.sh setup >> setup.log 2>&1
    - ./tellstick.sh install events >> setup.log 2>&1
    - ./tellstick.sh install scheduler >> setup.log 2>&1
    - ./tellstick.sh install upgrade >> setup.log 2>&1
    - ./tellstick.sh test
